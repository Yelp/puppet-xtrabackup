#!/bin/bash -e
#
# This file is managed by Puppet.  Edit the template, not the file on disk.
# (C) 2013 Bashton Ltd

DATE=$( date +%Y%m%d )

if [ $# -eq 2 ]; then
  if [ -e $1 ]; then
    mycnf_defaults=$1
  else
    echo "USAGE: $0 path/to/defaults.cnf database_name"
    exit
  fi
  dbname=$2
else
  echo "USAGE: $0 path/to/defaults.cnf database_name"
  exit
fi

OPTS="--defaults-extra-file=${mycnf_defaults} --no-version-check --stream=xbstream --parallel=<%= @parallel %>"

<% if @sshdest -%>
  SSHCMD="ssh <%= @sshdest %>"
  <% if @sshkey -%>
    SSHCMD="$SSHCMD -i <%= @sshkey %>"
  <% end -%>
<% end -%>

OPTS="$OPTS <%= @workdir %>"
<% if @slaveinfo -%>
  OPTS="$OPTS --slave-info"
<% end -%>
<% if @safeslave -%>
  OPTS="$OPTS --safe-slave-backup"
<% end -%>
<% if @gzip -%>
  OUTFILE="<%= @outputdir %>/${database_name}/${DATE}.xbstream.gz"
<% else -%>
  OUTFILE="<%= @outputdir %>/${database_name}/${DATE}.xbstream"
<% end -%>
<% if @sshdest -%>
  /usr/bin/innobackupex $OPTS | 
  <% if @gzip -%> gzip -c3 |<% end -%>
  $SSHCMD "cat - > $OUTFILE"
<% else -%>
  <% if @gzip -%>
    /usr/bin/innobackupex $OPTS | gzip -c9 > $OUTFILE
  <% else -%>
    /usr/bin/innobackupex $OPTS > $OUTFILE
  <% end -%>
<% end -%>
<% if @keepdays -%>
  $SSHCMD find "<%= @outputdir %>/${database_name}" -maxdepth 1 -name '*.xbstream*' -type f -mtime +<%= @keepdays %> -delete
<% end -%>
